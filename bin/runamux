#!/bin/bash

#
# █▀▄ █ █ █▄ █ ▄▀▄ █▄ ▄█ █ █ ▀▄▀
# █▀▄ ▀▄█ █ ▀█ █▀█ █ ▀ █ ▀▄█ █ █
#
#  a simple tmux session runner
#

set -u

# Get script install prefix, assuming script is ${PREFIX}/bin/runamux
prefix=$(cd -P "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)

readonly prefix

#
# Log message to stderr
#
m() {
  echo "[runamux] $*" >&2
}

#
# tmux shortcut
#
t() {
  tmux "$@"
}

#
# tmux, silent all output
#
s() {
  t "$@" &>/dev/null
}

#
# tmux, silent stderr only
#
e() {
  t "$@" 2>/dev/null
}

#
# Shortcut to 'tmux display-message -p'
#
d() {
  e display-message -p "$@"
}

#
# Get pane child process PID
#
pane-pid() {
  d -t "$1" '#{pane_pid}'
}

#
# Kill pane (kills child process, not just the pane)
#
kill-pane() {
  local pid

  m "Kill pane '$1'"

  if pid=$(pane-pid "$1") && (( pid )); then
    m "Kill child process (PID=$pid)"
    kill -SIGINT "$pid"
  fi
}

#
# Kill window
#
kill-window() {
  m "Kill window '$1'"

  e list-panes -t "$1" -F '#D #{pane_pid}' | while read -r id pid; do
    t set-option -pt "$id" remain-on-exit off
    m "Kill child process (PID=$pid)"
    kill -SIGINT "$pid"
  done
}

#
# Check if current server has session named '$1'
#
has-session() {
  s has-session -t "$1"
}

#
# Check if last created session has window named '$1'
#
has-window() {
  [ -z "$session" ] && return 1
  tmux list-windows -F '#W' -t "$session" | grep -sq "^$1$"
}

#
# Start a new detached session
#
session() {
  session=$1
  window=

  if has-session "$1"; then
    return
  fi

  m "Create session '$1'"

  t new-session -dn "${1}_placeholder" -s "$1" pause
  t set-environment -t "=$1" RUNAMUX_PREFIX "$prefix"
}

#
# Add a new window in last created session
#
window() {
  if [ -z "$session" ]; then
    return 1
  fi

  local killw=0

  if [ "$1" = -k ]; then
    killw=1
    shift
  fi

  window=$1

  if has-window "$1"; then
    if (( killw )); then
      kill-window "=$session:=$1"
    else
      return
    fi
  fi

  m "Create window '$1'"

  pane=$(e new-window -Pdn "$1" -t "=$session:" -F '#D' pause)

  local ph_name="${session}_placeholder"

  # close placeholder window
  if has-window "$ph_name"; then
    m "Close placeholder window for '$session'"
    kill-pane "=$session:=$ph_name"
  fi
}

#
# Create new pane (horizontal split)
#
pane() {
  if [ -z "$session" ] || [ -z "$window" ]; then
    return 1
  fi

  local newp

  m "Create pane '$*'"

  if newp=$(e split-window -Pht "=$session:=$window" -F '#D' "$@"); then
    t set-option -pt "$newp" remain-on-exit on
    t set-hook -pt "$newp" pane-died \
      "run -b $prefix/libexec/runamux/notify-died"
    t set-hook -pt "$newp" alert-bell \
      "run -b $prefix/libexec/runamux/notify-bell"
  fi

  # close placeholder pane
  if [ "$pane" ]; then
    m "Close placeholder pane '$pane'"
    kill-pane "$pane"
  fi

  pane=
}

#
# Print usage
#
usage() {
  echo "Usage: $0 CONFIG
Start a tmux session defined in the file CONFIG.

Options:

Argument CONFIG can be a path to a file as-is, the base
name of a .conf file, or a CONFIG.conf file in the
runamux config directory, first file found in that order
is used.

Runamux config directory is \$XDG_CONFIG_HOME/runamux.

The config file must be a Bash script. These functions are
available to start sessions, windows and panes:

  session NAME      Start new detached session.

  window [-k] NAME  Add a window to last created session.
                    If '-k' option passed, and a window
                    with same name exists, kill it.

  pane COMMAND...   Add a pane and run COMMAND in it.

Environment:

  XDG_CONFIG_HOME   Defaults to \$HOME/.config

Report bugs at https://github.com/241m/runamux"
}

version() {
  echo "$(basename "$0") 0.1.0"
  echo
  echo "Written by Zaim Bakar."
}

#
# main()
#

if [ -z "$1" ]; then
  usage
  exit 1
fi

case "$1" in
  -h|--help)
    usage
    exit
    ;;
  --version)
    version
    exit
esac

# some sanity checks
for f in runamux/notify-died runamux/notify-bell; do
  if [ ! -f "$prefix/libexec/$f" ]; then
    echo "Required libexec script not found: $f"
    exit 1
  fi
done

for f in $1 $1.conf "${XDG_CONFIG_HOME:-$HOME/.config}/runamux/$1.conf"; do
  # shellcheck source=/dev/null
  if [ -f "$f" ]; then
    . "$f"
    break
  fi
done
